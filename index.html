<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>vzlogger.conf editor</title>
<!--
    html: '',
    bootstrap2: '//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css',
    bootstrap3: '//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css',
    foundation3: '//cdnjs.cloudflare.com/ajax/libs/foundation/3.2.5/stylesheets/foundation.css',
    foundation4: '//cdn.jsdelivr.net/foundation/4.3.2/css/foundation.min.css',
    foundation5: '//cdn.jsdelivr.net/foundation/5.0.2/css/foundation.min.css',
    jqueryui: '//code.jquery.com/ui/1.10.3/themes/south-street/jquery-ui.css'
-->
    <link rel='stylesheet' href='//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css'>
<!--
    foundation2: '//cdnjs.cloudflare.com/ajax/libs/foundicons/2.0/stylesheets/general_foundicons.css',
    foundation3: '//cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/foundation-icons.css',
    fontawesome3: '//cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.css',
    fontawesome4: '//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css'
-->
    <link rel='stylesheet' href='//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css'>

    <style>
        [class*="foundicon-"] {font-family: GeneralFoundicons;font-style: normal;}
        .dev {display:none;}
    </style>
    <script src='//code.jquery.com/jquery-2.1.3.min.js'></script>
<!--
    <script src='js/jsoneditor.min.js'></script>
-->
    <script src='https://cdn.rawgit.com/jdorn/json-editor/master/dist/jsoneditor.min.js'></script>
    <script src='js/xregexp-min.js'></script>
</head>
<body>
<div class='container'>
    <div class='row'>
        <div class='span12 col-md-12 columns twelve large-12'>
            <h2>Config Editor</h2>
            <p>This editor can be used to validate and update vzlogger.conf configuration files.</p>

            <div id='editor'></div>
        </div>
    </div>

    <div class='row'>
        <div class='span12 col-md-12 columns twelve large-12'>
            <h2>Validation</h2>
            <p>This will show any validation errors.</p>
            <textarea id='validate' style='width: 100%; height: 100px; font-family: monospace;' readonly disabled class='form-control'></textarea>
        </div>
    </div>

    <div class='row'>
        <div class='span12 col-md-12 columns twelve large-12'>
            <h2>Generated vzlogger.conf</h2>
            <p>Copy paste the configuration below to your vzlogger.conf</p>
            <p>You can also make changes to the config file here and set the value in the editor by clicking <button class='btn btn-primary' id='setvalue'>Update</button></p>
            <textarea id='output' style='width: 100%; height: 300px; font-family: monospace;' class='form-control'></textarea>
        </div>
    </div>

    <div class='row' style='display:none'>
        <div class='span12 col-md-12 columns twelve large-12'>
            <h2>Options</h2>
            <div id='options_holder'>
                <div>
                    <label>Object Layout</label>
                    <select id='object_layout' class='form-control'>
                        <option value='normal'>normal</option>
                        <option value='grid'>grid</option>
                    </select>
                </div>
                <div>
                    <label>Show Errors</label>
                    <select id='show_errors' class='form-control'>
                        <option value='interaction'>On Interaction</option>
                        <option value='change'>On Field Change</option>
                        <option value='always'>Always</option>
                        <option value='never'>Never</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class='row dev'>
        <div class='span12 col-md-12 columns twelve large-12'>
            <h2>Schema</h2>
            <p>You can change the schema and see how the generated form looks.  After you make changes, click <button class='btn btn-primary' id='setschema'>Update Schema</button></p>

            <textarea id='schema' style='width: 100%; height: 450px; font-family: monospace;' class='form-control'></textarea>
        </div>
    </div>

</div>
<script>
(function() {
    // Divs/textareas on the page
    var $schema = document.getElementById('schema');
    var $output = document.getElementById('output');
    var $editor = document.getElementById('editor');
    var $validate = document.getElementById('validate');

    // Buttons
    var $set_schema_button = document.getElementById('setschema');
    var $set_value_button = document.getElementById('setvalue');

    var jsoneditor;

    // https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding#The_.22Unicode_Problem.22
    var b64_to_utf8 = function(str) {
        return decodeURIComponent(escape(window.atob(str.replace(/\s/g, ''))));
    };

    var reload = function(keep_value) {
        var startval = (jsoneditor && keep_value)? jsoneditor.getValue() : window.startval;
        window.startval = undefined;

        if(jsoneditor) jsoneditor.destroy();
        jsoneditor = new JSONEditor($editor,{
            schema: JSON.parse($schema.value),
            startval: startval
        });
        window.jsoneditor = jsoneditor;

        // When the value of the editor changes, update the JSON output and validation message
        jsoneditor.on('change',function() {
            var json = jsoneditor.getValue();

            $output.value = JSON.stringify(json,null,2);

            var validation_errors = jsoneditor.validate();
            // Show validation errors if there are any
            if(validation_errors.length) {
                $validate.value = JSON.stringify(validation_errors,null,2);
            }
            else {
                $validate.value = 'valid';
            }
        });
    };

    // Start the schema and output textareas with initial values
    $schema.value = JSON.stringify(schema,null,2);
    $output.value = '';

    // When the 'update form' button is clicked, set the editor's value
    $set_value_button.addEventListener('click',function() {
        try {
            var value = $output.value;

            // strip json comments
            value = value.replace(/\/\*.*?\*\//, "");
            value = value.replace(/\/\/.*?$/m, "");

            var json = JSON.parse(value);
            jsoneditor.setValue(json);
        }
        catch(e) {
            $validate.value = 'Invalid JSON: '+e.message;
        }
    });

    // Update the schema when the button is clicked
    $set_schema_button.addEventListener('click',function() {
        try {
            JSON.parse($schema.value);
            reload();
        }
        catch(e) {
            alert('Invalid Schema: '+e.message);
            return;
        }
    });

    var refreshBooleanOptions = function(no_reload) {
        var boolean_options = document.getElementById('boolean_options').children;
        for(var i=0; i<boolean_options.length; i++) {
            JSONEditor.defaults.options[boolean_options[i].value] = boolean_options[i].selected;
        }
        if(!no_reload) reload(true);
    };

    JSONEditor.defaults.options.ajax = true;

    JSONEditor.defaults.options.theme = 'bootstrap2';
    JSONEditor.defaults.options.iconlib = 'fontawesome4';

    JSONEditor.defaults.options.object_layout = 'normal';
    JSONEditor.defaults.options.show_errors = 'interaction';

    // required_by_default: Object properties required by default
    // no_additional_properties: No additional object properties
    // ajax: Allow loading schemas via Ajax
    // disable_edit_json: Disable "Edit JSON" buttons
    // disable_collapse: Disable collapse buttons
    // disable_properties: Disable properties buttons
    // disable_array_add: Disable array add buttons
    // disable_array_reorder: Disable array move buttons
    // disable_array_delete: Disable array delete buttons
    JSONEditor.defaults.options.disable_properties = true;

    // load schema
    var localhost = (document.location.host == 'localhost');
    var api = 'https://api.github.com/repos/volkszaehler/vzlogger';

    var schemaUrl = localhost ? 'schema.json'
        : api + '/contents/etc/vzlogger_generic.schema.json?ref=master';
    var configUrl = localhost ? 'vzlogger.conf'
        : api + '/contents/etc/vzlogger.conf?ref=master';

    $.when(
        $.ajax(schemaUrl).done(function(data) {
            if (!localhost) {
                data = b64_to_utf8(data.content);
            }
            if (typeof data !== 'string') {
                data = JSON.stringify(data, null, 2);
            }
            $schema.value = data;
        }).fail(function() {
            console.error('Could not load schema');
        }),
        $.ajax(configUrl).done(function(data) {
            if (!localhost) {
                data = b64_to_utf8(data.content);
            }
            if (typeof data !== 'string') {
                data = JSON.stringify(data, null, 2);
            }
            data = XRegExp.replace(data, XRegExp('[^:]\\/\\/.*$', 'mg'), ''); // single line comments
            data = XRegExp.replace(data, XRegExp('\\/\\*.*\\*\\/', 'sg'), ''); // multi line comments
            // console.log(data);
            $output.value = data;
        }).fail(function() {
            console.error('Could not load config');
        })
    ).done(function(data) {
        reload();
    });
})();
</script>
</body>
</html>
